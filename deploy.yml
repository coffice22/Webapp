name: Deploy to cPanel

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Prepare deployment files
        run: |
          # Cr√©er un dossier temporaire pour le d√©ploiement
          mkdir -p deploy_temp

          # Copier le contenu de dist/ (frontend build)
          cp -r dist/* deploy_temp/

          # Copier les fichiers backend et config
          cp -r api deploy_temp/
          cp -r database deploy_temp/
          cp .htaccess deploy_temp/

          # Cr√©er les dossiers n√©cessaires
          mkdir -p deploy_temp/api/uploads/documents
          mkdir -p deploy_temp/api/logs

          # Liste des fichiers √† d√©ployer
          ls -la deploy_temp/

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy_temp/
          server-dir: ./public_html/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/src/**
            **/.env
            **/package*.json
            **/tsconfig*.json
            **/vite.config.ts
            **/postcss.config.js
            **/tailwind.config.js

      - name: Notification
        if: success()
        run: |
          echo "‚úÖ D√©ploiement r√©ussi sur https://coffice.dz"
          echo "üì¶ Version d√©ploy√©e: $(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')"

      - name: Notification √©chec
        if: failure()
        run: |
          echo "‚ùå √âchec du d√©ploiement"
          echo "V√©rifiez les logs ci-dessus pour plus de d√©tails"
